/*!
 * 
 * three-voxel-loader v1.1.0       Thu Mar 05 2020 02:11:15 GMT+0000 (Coordinated Universal Time)
 * by André Storhaug    andr3.storhaug@gmail.com
 * https://github.com/andstor/three-voxel-loader
 * 
 * Copyright: 2020 André Storhaug
 * License: MIT
 * 
 * Build: 913bb1ebf6d4d4ba21ce
 * 
 */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("THREE")):"function"==typeof define&&define.amd?define(["THREE"],e):"object"==typeof exports?exports.VoxelLoader=e(require("THREE")):t.VoxelLoader=e(t.THREE)}(this,(function(t){return function(t){var e={};function n(r){if(e[r])return e[r].exports;var i=e[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(r,i,function(e){return t[e]}.bind(null,i));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=3)}([function(e,n){e.exports=t},function(t,e,n){"use strict";t.exports=(t,{include:e,exclude:n}={})=>{const r=t=>{const r=e=>"string"==typeof e?t===e:e.test(t);return e?e.some(r):!n||!n.some(r)};for(const[e,n]of(t=>{const e=new Set;do{for(const n of Reflect.ownKeys(t))e.add([t,n])}while((t=Reflect.getPrototypeOf(t))&&t!==Object.prototype);return e})(t.constructor.prototype)){if("constructor"===n||!r(n))continue;const i=Reflect.getOwnPropertyDescriptor(e,n);i&&"function"==typeof i.value&&(t[n]=t[n].bind(t))}return t}},function(t,e,n){t.exports=n(4).format.vox},function(t,e,n){t.exports=n(6).default},function(t,e,n){(function(t){var n=e;!function(t){"use strict";n.format=n.format||{},n.format.vox=n.format.vox||{};var e=function(){return M.__string_rec(this,"")};function r(t,e){function n(){}n.prototype=t;var r=new n;for(var i in e)r[i]=e[i];return e.toString!==Object.prototype.toString&&(r.toString=e.toString),r}var i=function(){};i.__name__=!0,i.cca=function(t,e){var n=t.charCodeAt(e);if(n==n)return n},Math.__name__=!0;var s=function(){};s.__name__=!0,s.string=function(t){return M.__string_rec(t,"")},s.parseInt=function(t){var e=parseInt(t,10);return 0!=e||120!=i.cca(t,1)&&88!=i.cca(t,1)||(e=parseInt(t)),isNaN(e)?null:e};var a=n.format.vox.VoxNodeTools=function(){};a.__name__=!0,a.walkNodeGraph=function(t,e){e.beginGraph(t),a.nodeWalker(t.nodeGraph,e),e.endGraph()},a.nodeWalker=function(t,e){if(null==t)console.log("VoxNodeTools.hx:30:","TODO (DK)");else switch(t[1]){case 0:e.onTransform(t[5][0]),a.nodeWalker(t[6],e);break;case 1:var n=t[3];e.beginGroup(t[2]);for(var r=0;r<n.length;)a.nodeWalker(n[r++],e);e.endGroup();break;case 2:e.onShape(t[2],t[3])}};var o=n.format.vox.VoxReader=function(){};o.__name__=!0,o.read=function(t,e){if(null!=t){var n=new z(w.ofData(t));if("VOX "==n.readString(4)){var r=n.readInt32();if(150==r){var i=new f;i.palette=o.get_DefaultPalette().map(u.transformColor);var s=[];o.readChunk(n,i,s,{modelIndex:0,sizeIndex:0}),s.length>0&&(i.nodeGraph=o.buildNodeGraph(i,s,0)),e(i,null)}else e(null,'Unsupported version "'+r+'"')}else e(null,'Expected "VOX " header')}else e(null,"Invalid input")},o.readChunk=function(t,e,n,r){var i=t.readString(4),s=t.readInt32(),a=t.readInt32();switch(i){case"MAIN":break;case"MATL":for(var l=t.readInt32(),y=new p,f=0,m=t.readInt32();f<m;){++f;var w=t.read(t.readInt32()).toString(),g=t.read(t.readInt32()).toString();null!=T[w]?y.setReserved(w,g):y.h[w]=g}e.materials[l]=y;break;case"PACK":t.readInt32();break;case"RGBA":for(var z=o.get_DefaultPalette(),_=0;_<255;)z[1+_++]=t.readInt32();t.readInt32(),e.palette=z.map(u.transformColor);break;case"SIZE":e.sizes[r.sizeIndex++]=new d(t.readInt32(),t.readInt32(),t.readInt32());break;case"XYZI":for(var v=e.models,b=r.modelIndex++,M=[],S=0,O=t.readInt32();S<O;)++S,M.push(new x(t.readByte(),t.readByte(),t.readByte(),t.readByte()));v[b]=M;break;case"nGRP":for(var P=t.readInt32(),V=new p,k=0,I=t.readInt32();k<I;){++k;var D=t.read(t.readInt32()).toString(),B=t.read(t.readInt32()).toString();null!=T[D]?V.setReserved(D,B):V.h[D]=B}for(var q=t.readInt32(),A=[],E=0;E<q;)++E,A.push(t.readInt32());n[P]=h.GroupNodeData(V,A);break;case"nSHP":for(var L=t.readInt32(),j=new p,N=0,C=t.readInt32();N<C;){++N;var R=t.read(t.readInt32()).toString(),F=t.read(t.readInt32()).toString();null!=T[R]?j.setReserved(R,F):j.h[R]=F}for(var U=t.readInt32(),G=[],H=0;H<U;){++H;for(var X=t.readInt32(),Y=new p,Z=0,K=t.readInt32();Z<K;){++Z;var Q=t.read(t.readInt32()).toString(),W=t.read(t.readInt32()).toString();null!=T[Q]?Y.setReserved(Q,W):Y.h[Q]=W}G.push(new c(X,Y))}n[L]=h.ShapeNodeData(j,G);break;case"nTRN":for(var $=t.readInt32(),J=new p,tt=0,et=t.readInt32();tt<et;){++tt;var nt=t.read(t.readInt32()).toString(),rt=t.read(t.readInt32()).toString();null!=T[nt]?J.setReserved(nt,rt):J.h[nt]=rt}for(var it=t.readInt32(),st=t.readInt32(),at=t.readInt32(),ot=t.readInt32(),ht=[],ut=0;ut<ot;){++ut;for(var lt=new p,ct=0,yt=t.readInt32();ct<yt;){++ct;var dt=t.read(t.readInt32()).toString(),ft=t.read(t.readInt32()).toString();null!=T[dt]?lt.setReserved(dt,ft):lt.h[dt]=ft}ht.push(lt)}n[$]=h.TransformNodeData(J,it,st,at,ht);break;default:t.read(s)}for(var xt=12+s+a;a>0;)a-=o.readChunk(t,e,n,r);return xt},o.buildNodeGraph=function(t,e,n){var r=e[n];switch(r[1]){case 0:return y.Transform(r[2],r[4],r[5],r[6],o.buildNodeGraph(t,e,r[3]));case 1:for(var i=r[3],s=r[2],a=[],h=0;h<i.length;)a.push(o.buildNodeGraph(t,e,i[h++]));return y.Group(s,a);case 2:return y.Shape(r[2],r[3])}},o.readVoxel=function(t){return new x(t.readByte(),t.readByte(),t.readByte(),t.readByte())},o.readMaterial=function(t){for(var e=t.readInt32(),n=new p,r=0,i=t.readInt32();r<i;){++r;var s=t.read(t.readInt32()).toString(),a=t.read(t.readInt32()).toString();null!=T[s]?n.setReserved(s,a):n.h[s]=a}return{id:e,props:n}},o.readDict=function(t){for(var e=new p,n=0,r=t.readInt32();n<r;){++n;var i=t.read(t.readInt32()).toString(),s=t.read(t.readInt32()).toString();null!=T[i]?e.setReserved(i,s):e.h[i]=s}return e},o.i32=function(t){return t.readInt32()},o.byte=function(t){return t.readByte()},o.string=function(t){return t.read(t.readInt32()).toString()},o.get_DefaultPalette=function(){return[0,-1,-3342337,-6684673,-10027009,-13369345,-16711681,-13057,-3355393,-6697729,-10040065,-13382401,-16724737,-26113,-3368449,-6710785,-10053121,-13395457,-16737793,-39169,-3381505,-6723841,-10066177,-13408513,-16750849,-52225,-3394561,-6736897,-10079233,-13421569,-16763905,-65281,-3407617,-6749953,-10092289,-13434625,-16776961,-52,-3342388,-6684724,-10027060,-13369396,-16711732,-13108,-3355444,-6697780,-10040116,-13382452,-16724788,-26164,-3368500,-6710836,-10053172,-13395508,-16737844,-39220,-3381556,-6723892,-10066228,-13408564,-16750900,-52276,-3394612,-6736948,-10079284,-13421620,-16763956,-65332,-3407668,-6750004,-10092340,-13434676,-16777012,-103,-3342439,-6684775,-10027111,-13369447,-16711783,-13159,-3355495,-6697831,-10040167,-13382503,-16724839,-26215,-3368551,-6710887,-10053223,-13395559,-16737895,-39271,-3381607,-6723943,-10066279,-13408615,-16750951,-52327,-3394663,-6736999,-10079335,-13421671,-16764007,-65383,-3407719,-6750055,-10092391,-13434727,-16777063,-154,-3342490,-6684826,-10027162,-13369498,-16711834,-13210,-3355546,-6697882,-10040218,-13382554,-16724890,-26266,-3368602,-6710938,-10053274,-13395610,-16737946,-39322,-3381658,-6723994,-10066330,-13408666,-16751002,-52378,-3394714,-6737050,-10079386,-13421722,-16764058,-65434,-3407770,-6750106,-10092442,-13434778,-16777114,-205,-3342541,-6684877,-10027213,-13369549,-16711885,-13261,-3355597,-6697933,-10040269,-13382605,-16724941,-26317,-3368653,-6710989,-10053325,-13395661,-16737997,-39373,-3381709,-6724045,-10066381,-13408717,-16751053,-52429,-3394765,-6737101,-10079437,-13421773,-16764109,-65485,-3407821,-6750157,-10092493,-13434829,-16777165,-256,-3342592,-6684928,-10027264,-13369600,-16711936,-13312,-3355648,-6697984,-10040320,-13382656,-16724992,-26368,-3368704,-6711040,-10053376,-13395712,-16738048,-39424,-3381760,-6724096,-10066432,-13408768,-16751104,-52480,-3394816,-6737152,-10079488,-13421824,-16764160,-65536,-3407872,-6750208,-10092544,-13434880,-16776978,-16776995,-16777029,-16777046,-16777080,-16777097,-16777131,-16777148,-16777182,-16777199,-16716288,-16720640,-16729344,-16733696,-16742400,-16746752,-16755456,-16759808,-16768512,-16772864,-1179648,-2293760,-4521984,-5636096,-7864320,-8978432,-11206656,-12320768,-14548992,-15663104,-1118482,-2236963,-4473925,-5592406,-7829368,-8947849,-11184811,-12303292,-14540254,-15658735]};var h={__ename__:!0,__constructs__:["TransformNodeData","GroupNodeData","ShapeNodeData"],TransformNodeData:function(t,n,r,i,s){var a=["TransformNodeData",0,t,n,r,i,s];return a.__enum__=h,a.toString=e,a},GroupNodeData:function(t,n){var r=["GroupNodeData",1,t,n];return r.__enum__=h,r.toString=e,r},ShapeNodeData:function(t,n){var r=["ShapeNodeData",2,t,n];return r.__enum__=h,r.toString=e,r}},u=n.format.vox.VoxTools=function(){};u.__name__=!0,u.transformYZ=function(t){for(var e=0,n=t.models.length;e<n;)for(var r=e++,i=t.sizes[r].y,s=0,a=t.models[r];s<a.length;){var o=a[s];++s;var h=o.y;o.y=o.z,o.z=i-1-h}},u.transformColor=function(t){return new l(255&t,t>>8&255,t>>16&255,t>>24&255)},u.dictHasTranslation=function(t){return null!=(null!=T._t?t.getReserved("_t"):t.h._t)},u.getTranslationFromDict=function(t){var e=null!=T._t?t.getReserved("_t"):t.h._t;if(null==e)return{x:0,y:0,z:0};var n=e.split(" ");return{x:s.parseInt(n[0]),y:s.parseInt(n[1]),z:s.parseInt(n[2])}},u.dictHasRotation=function(t){return null!=(null!=T._r?t.getReserved("_r"):t.h._r)},u.getRotationFromDict=function(t){var e=null!=T._r?t.getReserved("_r"):t.h._r;if(null==e)return{_00:1,_10:0,_20:0,_01:0,_11:1,_21:0,_02:0,_12:0,_22:1};var n,r=s.parseInt(e),i=0==(16&r)?1:-1,a=0==(32&r)?1:-1,o=0==(64&r)?1:-1,h=(1&r)+(2&r),u=(r>>2&1)+(r>>2&2);switch(h){case 0:switch(u){case 1:n=2;break;case 2:n=1;break;default:console.log("VoxTools.hx:90:","missing r0;r1 match"),n=0}break;case 1:switch(u){case 0:n=2;break;case 2:n=0;break;default:console.log("VoxTools.hx:90:","missing r0;r1 match"),n=0}break;case 2:switch(u){case 0:n=1;break;case 1:n=0;break;default:console.log("VoxTools.hx:90:","missing r0;r1 match"),n=0}break;default:console.log("VoxTools.hx:90:","missing r0;r1 match"),n=0}return{_00:0==h?i:0,_10:1==h?i:0,_20:2==h?i:0,_01:0==u?a:0,_11:1==u?a:0,_21:2==u?a:0,_02:0==n?o:0,_12:1==n?o:0,_22:2==n?o:0}};var l=function(t,e,n,r){this.r=t,this.g=e,this.b=n,this.a=r};l.__name__=!0;var c=function(t,e){this.modelId=t,this.attributes=e};c.__name__=!0;var y={__ename__:!0,__constructs__:["Transform","Group","Shape"],Transform:function(t,n,r,i,s){var a=["Transform",0,t,n,r,i,s];return a.__enum__=y,a.toString=e,a},Group:function(t,n){var r=["Group",1,t,n];return r.__enum__=y,r.toString=e,r},Shape:function(t,n){var r=["Shape",2,t,n];return r.__enum__=y,r.toString=e,r}},d=function(t,e,n){this.x=t,this.y=e,this.z=n};d.__name__=!0;var f=function(){this.materials=[],this.models=[],this.sizes=[]};f.__name__=!0;var x=function(t,e,n,r){this.x=t,this.y=e,this.z=n,this.colorIndex=r};x.__name__=!0;var m=function(){};m.__name__=!0;var p=function(){this.h={}};p.__name__=!0,p.__interfaces__=[m],p.prototype={setReserved:function(t,e){null==this.rh&&(this.rh={}),this.rh["$"+t]=e},getReserved:function(t){return null==this.rh?null:this.rh["$"+t]}};var w=function(t){this.length=t.byteLength,this.b=new V(t),this.b.bufferValue=t,t.hxBytes=this,t.bytes=this.b};w.__name__=!0,w.ofData=function(t){var e=t.hxBytes;return null!=e?e:new w(t)},w.prototype={getString:function(t,e){if(t<0||e<0||t+e>this.length)throw new b(v.OutsideBounds);for(var n="",r=this.b,i=String.fromCharCode,s=t,a=t+e;s<a;){var o=r[s++];if(o<128){if(0==o)break;n+=i(o)}else if(o<224)n+=i((63&o)<<6|127&r[s++]);else if(o<240)n+=i((31&o)<<12|(127&r[s++])<<6|127&r[s++]);else{var h=(15&o)<<18|(127&r[s++])<<12|(127&r[s++])<<6|127&r[s++];n+=i(55232+(h>>10)),n+=i(1023&h|56320)}}return n},toString:function(){return this.getString(0,this.length)}};var g=function(){};g.__name__=!0,g.prototype={readByte:function(){throw new b("Not implemented")},readBytes:function(t,e,n){var r=n,i=t.b;if(e<0||n<0||e+n>t.length)throw new b(v.OutsideBounds);try{for(;r>0;)i[e]=this.readByte(),++e,--r}catch(t){if(!(t instanceof b?t.val:t instanceof _))throw t}return n-r},readFullBytes:function(t,e,n){for(;n>0;){var r=this.readBytes(t,e,n);if(0==r)throw new b(v.Blocked);e+=r,n-=r}},read:function(t){for(var e=new w(new P(t)),n=0;t>0;){var r=this.readBytes(e,n,t);if(0==r)throw new b(v.Blocked);n+=r,t-=r}return e},readInt32:function(){var t=this.readByte(),e=this.readByte(),n=this.readByte(),r=this.readByte();return this.bigEndian?r|n<<8|e<<16|t<<24:t|e<<8|n<<16|r<<24},readString:function(t){var e=new w(new P(t));return this.readFullBytes(e,0,t),e.toString()}};var z=function(t,e,n){if(null==e&&(e=0),null==n&&(n=t.length-e),e<0||n<0||e+n>t.length)throw new b(v.OutsideBounds);this.b=t.b,this.pos=e,this.len=n,this.totlen=n};z.__name__=!0,z.__super__=g,z.prototype=r(g.prototype,{readByte:function(){if(0==this.len)throw new b(new _);return this.len--,this.b[this.pos++]},readBytes:function(t,e,n){if(e<0||n<0||e+n>t.length)throw new b(v.OutsideBounds);if(0==this.len&&n>0)throw new b(new _);this.len<n&&(n=this.len);for(var r=this.b,i=t.b,s=0,a=n;s<a;){var o=s++;i[e+o]=r[this.pos+o]}return this.pos+=n,this.len-=n,n}});var _=function(){};_.__name__=!0,_.prototype={toString:function(){return"Eof"}};var v={__ename__:!0,__constructs__:["Blocked","Overflow","OutsideBounds","Custom"],Blocked:["Blocked",0]};v.Blocked.toString=e,v.Blocked.__enum__=v,v.Overflow=["Overflow",1],v.Overflow.toString=e,v.Overflow.__enum__=v,v.OutsideBounds=["OutsideBounds",2],v.OutsideBounds.toString=e,v.OutsideBounds.__enum__=v,v.Custom=function(t){var n=["Custom",3,t];return n.__enum__=v,n.toString=e,n};var b=function(t){Error.call(this),this.val=t,Error.captureStackTrace&&Error.captureStackTrace(this,b)};b.__name__=!0,b.wrap=function(t){return t instanceof Error?t:new b(t)},b.__super__=Error,b.prototype=r(Error.prototype,{});var M=function(){};M.__name__=!0,M.__string_rec=function(t,e){if(null==t)return"null";if(e.length>=5)return"<...>";var n=typeof t;switch("function"==n&&(t.__name__||t.__ename__)&&(n="object"),n){case"function":return"<function>";case"object":if(t instanceof Array){if(t.__enum__){if(2==t.length)return t[0];var r=t[0]+"(";e+="\t";for(var i=2,s=t.length;i<s;){var a=i++;r+=2!=a?","+M.__string_rec(t[a],e):M.__string_rec(t[a],e)}return r+")"}var o="[";e+="\t";for(var h=0,u=t.length;h<u;){var l=h++;o+=(l>0?",":"")+M.__string_rec(t[l],e)}return o+="]"}var c;try{c=t.toString}catch(t){t instanceof b&&t.val;return"???"}if(null!=c&&c!=Object.toString&&"function"==typeof c){var y=t.toString();if("[object Object]"!=y)return y}var d=null,f="{\n";e+="\t";var x=null!=t.hasOwnProperty;for(var d in t)x&&!t.hasOwnProperty(d)||"prototype"!=d&&"__class__"!=d&&"__super__"!=d&&"__interfaces__"!=d&&"__properties__"!=d&&(2!=f.length&&(f+=", \n"),f+=e+d+" : "+M.__string_rec(t[d],e));return f+="\n"+(e=e.substring(1))+"}";case"string":return t;default:return String(t)}};var S=function(t){if(t instanceof Array&&null==t.__enum__)this.a=t,this.byteLength=t.length;else{var e=t;this.a=[];for(var n=0;n<e;)this.a[n++]=0;this.byteLength=e}};S.__name__=!0,S.sliceImpl=function(t,e){var n=new V(this,t,null==e?null:e-t),r=new P(n.byteLength);return new V(r).set(n),r},S.prototype={slice:function(t,e){return new S(this.a.slice(t,e))}};var O=function(){};O.__name__=!0,O._new=function(t,e,n){var r;if("number"==typeof t){r=[];for(var i=0,a=t;i<a;){r[i++]=0}r.byteLength=r.length,r.byteOffset=0,r.buffer=new S(r)}else if(t instanceof S){var o=t;null==e&&(e=0),null==n&&(n=o.byteLength-e),(r=0==e?o.a:o.a.slice(e,e+n)).byteLength=r.length,r.byteOffset=e,r.buffer=o}else{if(!(t instanceof Array&&null==t.__enum__))throw new b("TODO "+s.string(t));(r=t.slice()).byteLength=r.length,r.byteOffset=0,r.buffer=new S(r)}return r.subarray=O._subarray,r.set=O._set,r},O._set=function(t,e){if(t.buffer instanceof S){var n=t;if(t.byteLength+e>this.byteLength)throw new b("set() outside of range");for(var r=0,i=t.byteLength;r<i;){var s=r++;this[s+e]=n[s]}}else{if(!(t instanceof Array&&null==t.__enum__))throw new b("TODO");var a=t;if(a.length+e>this.byteLength)throw new b("set() outside of range");for(var o=0,h=a.length;o<h;){var u=o++;this[u+e]=a[u]}}},O._subarray=function(t,e){var n=O._new(this.slice(t,e));return n.byteOffset=t,n},String.__name__=!0,Array.__name__=!0;var T={};Object.defineProperty(b.prototype,"message",{get:function(){return String(this.val)}});var P=t.ArrayBuffer||S;null==P.prototype.slice&&(P.prototype.slice=S.sliceImpl);var V=t.Uint8Array||O._new;u.TranslationKey="_t",u.RotationKey="_r",O.BYTES_PER_ELEMENT=1}("undefined"!=typeof window?window:void 0!==t?t:"undefined"!=typeof self?self:this);n.format}).call(this,n(5))},function(t,e){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(t){"object"==typeof window&&(n=window)}t.exports=n},function(t,e,n){"use strict";n.r(e);var r=n(1),i=n.n(r),s=n(0);
/**
 * math-ds v1.1.4 build Thu Jan 23 2020
 * https://github.com/vanruesc/math-ds
 * Copyright 2020 Raoul van Rüschen
 * @license Zlib
 */
class a{constructor(t=0,e=0,n=0){this.x=t,this.y=e,this.z=n}set(t,e,n){return this.x=t,this.y=e,this.z=n,this}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}clone(){return new this.constructor(this.x,this.y,this.z)}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}setFromSpherical(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)}setFromSphericalCoords(t,e,n){const r=Math.sin(e)*t;return this.x=r*Math.sin(n),this.y=Math.cos(e)*t,this.z=r*Math.cos(n),this}setFromCylindrical(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)}setFromCylindricalCoords(t,e,n){return this.x=t*Math.sin(e),this.y=n,this.z=t*Math.cos(e),this}setFromMatrix3Column(t,e){return this.fromArray(t.elements,3*e)}setFromMatrixColumn(t,e){return this.fromArray(t.elements,4*e)}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(t){const e=this.setFromMatrixColumn(t,0).length(),n=this.setFromMatrixColumn(t,1).length(),r=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=n,this.z=r,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){return this.x/=t,this.y/=t,this.z/=t,this}crossVectors(t,e){const n=t.x,r=t.y,i=t.z,s=e.x,a=e.y,o=e.z;return this.x=r*o-i*a,this.y=i*s-n*o,this.z=n*a-r*s,this}cross(t){return this.crossVectors(this,t)}transformDirection(t){const e=this.x,n=this.y,r=this.z,i=t.elements;return this.x=i[0]*e+i[4]*n+i[8]*r,this.y=i[1]*e+i[5]*n+i[9]*r,this.z=i[2]*e+i[6]*n+i[10]*r,this.normalize()}applyMatrix3(t){const e=this.x,n=this.y,r=this.z,i=t.elements;return this.x=i[0]*e+i[3]*n+i[6]*r,this.y=i[1]*e+i[4]*n+i[7]*r,this.z=i[2]*e+i[5]*n+i[8]*r,this}applyNormalMatrix(t){return this.applyMatrix3(t).normalize()}applyMatrix4(t){const e=this.x,n=this.y,r=this.z,i=t.elements;return this.x=i[0]*e+i[4]*n+i[8]*r+i[12],this.y=i[1]*e+i[5]*n+i[9]*r+i[13],this.z=i[2]*e+i[6]*n+i[10]*r+i[14],this}applyQuaternion(t){const e=this.x,n=this.y,r=this.z,i=t.x,s=t.y,a=t.z,o=t.w,h=o*e+s*r-a*n,u=o*n+a*e-i*r,l=o*r+i*n-s*e,c=-i*e-s*n-a*r;return this.x=h*o+c*-i+u*-a-l*-s,this.y=u*o+c*-s+l*-i-h*-a,this.z=l*o+c*-a+h*-s-u*-i,this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}reflect(t){const e=t.x,n=t.y,r=t.z;return this.sub(t.multiplyScalar(2*this.dot(t))),t.set(e,n,r),this}angleTo(t){const e=this.dot(t)/Math.sqrt(this.lengthSquared()*t.lengthSquared());return Math.acos(Math.min(Math.max(e,-1),1))}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}distanceToSquared(t){const e=this.x-t.x,n=this.y-t.y,r=this.z-t.z;return e*e+n*n+r*r}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}normalize(){return this.divideScalar(this.length())}setLength(t){return this.normalize().multiplyScalar(t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}lerpVectors(t,e,n){return this.subVectors(e,t).multiplyScalar(n).add(t)}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}}const o=new a,h=[new a,new a,new a,new a,new a,new a,new a,new a];class u{constructor(t=new a(1/0,1/0,1/0),e=new a(-1/0,-1/0,-1/0)){this.min=t,this.max=e}set(t,e){return this.min.copy(t),this.max.copy(e),this}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}clone(){return(new this.constructor).copy(this)}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(t=new a){return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t=new a){return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)}setFromSphere(t){return this.set(t.center,t.center),this.expandByScalar(t.radius),this}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}setFromPoints(t){let e,n;for(this.min.set(0,0,0),this.max.set(0,0,0),e=0,n=t.length;e<n;++e)this.expandByPoint(t[e]);return this}setFromCenterAndSize(t,e){const n=o.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(n),this.max.copy(t).add(n),this}clampPoint(t,e=new a){return e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return o.copy(t).clamp(this.min,this.max).sub(t).length()}applyMatrix4(t){const e=this.min,n=this.max;return this.isEmpty()||(h[0].set(e.x,e.y,e.z).applyMatrix4(t),h[1].set(e.x,e.y,n.z).applyMatrix4(t),h[2].set(e.x,n.y,e.z).applyMatrix4(t),h[3].set(e.x,n.y,n.z).applyMatrix4(t),h[4].set(n.x,e.y,e.z).applyMatrix4(t),h[5].set(n.x,e.y,n.z).applyMatrix4(t),h[6].set(n.x,n.y,e.z).applyMatrix4(t),h[7].set(n.x,n.y,n.z).applyMatrix4(t),this.setFromPoints(h)),this}translate(t){return this.min.add(t),this.max.add(t),this}intersect(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}containsPoint(t){const e=this.min,n=this.max;return t.x>=e.x&&t.y>=e.y&&t.z>=e.z&&t.x<=n.x&&t.y<=n.y&&t.z<=n.z}containsBox(t){const e=this.min,n=this.max,r=t.min,i=t.max;return e.x<=r.x&&i.x<=n.x&&e.y<=r.y&&i.y<=n.y&&e.z<=r.z&&i.z<=n.z}intersectsBox(t){const e=this.min,n=this.max,r=t.min,i=t.max;return i.x>=e.x&&i.y>=e.y&&i.z>=e.z&&r.x<=n.x&&r.y<=n.y&&r.z<=n.z}intersectsSphere(t){return this.clampPoint(t.center,o).distanceToSquared(t.center)<=t.radius*t.radius}intersectsPlane(t){let e,n;return t.normal.x>0?(e=t.normal.x*this.min.x,n=t.normal.x*this.max.x):(e=t.normal.x*this.max.x,n=t.normal.x*this.min.x),t.normal.y>0?(e+=t.normal.y*this.min.y,n+=t.normal.y*this.max.y):(e+=t.normal.y*this.max.y,n+=t.normal.y*this.min.y),t.normal.z>0?(e+=t.normal.z*this.min.z,n+=t.normal.z*this.max.z):(e+=t.normal.z*this.max.z,n+=t.normal.z*this.min.z),e<=-t.constant&&n>=-t.constant}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}new u,new a;class l{constructor(t=0,e=0){this.x=t,this.y=e}get width(){return this.x}set width(t){return this.x=t}get height(){return this.y}set height(t){return this.y=t}set(t,e){return this.x=t,this.y=e,this}copy(t){return this.x=t.x,this.y=t.y,this}clone(){return new this.constructor(this.x,this.y)}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t}add(t){return this.x+=t.x,this.y+=t.y,this}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.x/=t,this.y/=t,this}applyMatrix3(t){const e=this.x,n=this.y,r=t.elements;return this.x=r[0]*e+r[3]*n+r[6],this.y=r[1]*e+r[4]*n+r[7],this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}lengthSquared(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}distanceToSquared(t){const e=this.x-t.x,n=this.y-t.y;return e*e+n*n}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}normalize(){return this.divideScalar(this.length())}setLength(t){return this.normalize().multiplyScalar(t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}angle(){let t=Math.atan2(this.y,this.x);return t<0&&(t+=2*Math.PI),t}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,n){return this.subVectors(e,t).multiplyScalar(n).add(t)}rotateAround(t,e){const n=Math.cos(e),r=Math.sin(e),i=this.x-t.x,s=this.y-t.y;return this.x=i*n-s*r+t.x,this.y=i*r+s*n+t.y,this}equals(t){return t.x===this.x&&t.y===this.y}}new l;const c="XYZ",y="YZX",d="ZXY",f="XZY",x="YXZ",m="ZYX";new class{constructor(){this.elements=new Float32Array([1,0,0,0,1,0,0,0,1])}set(t,e,n,r,i,s,a,o,h){const u=this.elements;return u[0]=t,u[3]=e,u[6]=n,u[1]=r,u[4]=i,u[7]=s,u[2]=a,u[5]=o,u[8]=h,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(t){const e=t.elements,n=this.elements;return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[8]=e[8],this}clone(){return(new this.constructor).fromArray(this.elements)}fromArray(t,e=0){const n=this.elements;let r;for(r=0;r<9;++r)n[r]=t[r+e];return this}toArray(t=[],e=0){const n=this.elements;let r;for(r=0;r<9;++r)t[r+e]=n[r];return t}multiplyMatrices(t,e){const n=t.elements,r=e.elements,i=this.elements,s=n[0],a=n[3],o=n[6],h=n[1],u=n[4],l=n[7],c=n[2],y=n[5],d=n[8],f=r[0],x=r[3],m=r[6],p=r[1],w=r[4],g=r[7],z=r[2],_=r[5],v=r[8];return i[0]=s*f+a*p+o*z,i[3]=s*x+a*w+o*_,i[6]=s*m+a*g+o*v,i[1]=h*f+u*p+l*z,i[4]=h*x+u*w+l*_,i[7]=h*m+u*g+l*v,i[2]=c*f+y*p+d*z,i[5]=c*x+y*w+d*_,i[8]=c*m+y*g+d*v,this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}determinant(){const t=this.elements,e=t[0],n=t[1],r=t[2],i=t[3],s=t[4],a=t[5],o=t[6],h=t[7],u=t[8];return e*s*u-e*a*h-n*i*u+n*a*o+r*i*h-r*s*o}getInverse(t){const e=t.elements,n=this.elements,r=e[0],i=e[1],s=e[2],a=e[3],o=e[4],h=e[5],u=e[6],l=e[7],c=e[8],y=c*o-h*l,d=h*u-c*a,f=l*a-o*u,x=r*y+i*d+s*f;let m;return 0!==x?(m=1/x,n[0]=y*m,n[1]=(s*l-c*i)*m,n[2]=(h*i-s*o)*m,n[3]=d*m,n[4]=(c*r-s*u)*m,n[5]=(s*a-h*r)*m,n[6]=f*m,n[7]=(i*u-l*r)*m,n[8]=(o*r-i*a)*m):(console.error("Can't invert matrix, determinant is zero",t),this.identity()),this}transpose(){const t=this.elements;let e;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}scale(t,e){const n=this.elements;return n[0]*=t,n[3]*=t,n[6]*=t,n[1]*=e,n[4]*=e,n[7]*=e,this}rotate(t){const e=Math.cos(t),n=Math.sin(t),r=this.elements,i=r[0],s=r[3],a=r[6],o=r[1],h=r[4],u=r[7];return r[0]=e*i+n*o,r[3]=e*s+n*h,r[6]=e*a+n*u,r[1]=-n*i+e*o,r[4]=-n*s+e*h,r[7]=-n*a+e*u,this}translate(t,e){const n=this.elements;return n[0]+=t*n[2],n[3]+=t*n[5],n[6]+=t*n[8],n[1]+=e*n[2],n[4]+=e*n[5],n[7]+=e*n[8],this}equals(t){const e=this.elements,n=t.elements;let r,i=!0;for(r=0;i&&r<9;++r)e[r]!==n[r]&&(i=!1);return i}},new class{constructor(t=0,e=0,n=0,r=0){this.x=t,this.y=e,this.z=n,this.w=r}set(t,e,n,r){return this.x=t,this.y=e,this.z=n,this.w=r,this}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t}setFromEuler(t){const e=t.x,n=t.y,r=t.z,i=Math.cos,s=Math.sin,a=i(e/2),o=i(n/2),h=i(r/2),u=s(e/2),l=s(n/2),p=s(r/2);switch(t.order){case c:this.x=u*o*h+a*l*p,this.y=a*l*h-u*o*p,this.z=a*o*p+u*l*h,this.w=a*o*h-u*l*p;break;case x:this.x=u*o*h+a*l*p,this.y=a*l*h-u*o*p,this.z=a*o*p-u*l*h,this.w=a*o*h+u*l*p;break;case d:this.x=u*o*h-a*l*p,this.y=a*l*h+u*o*p,this.z=a*o*p+u*l*h,this.w=a*o*h-u*l*p;break;case m:this.x=u*o*h-a*l*p,this.y=a*l*h+u*o*p,this.z=a*o*p-u*l*h,this.w=a*o*h+u*l*p;break;case y:this.x=u*o*h+a*l*p,this.y=a*l*h+u*o*p,this.z=a*o*p-u*l*h,this.w=a*o*h-u*l*p;break;case f:this.x=u*o*h-a*l*p,this.y=a*l*h-u*o*p,this.z=a*o*p+u*l*h,this.w=a*o*h+u*l*p}return this}setFromAxisAngle(t,e){const n=e/2,r=Math.sin(n);return this.x=t.x*r,this.y=t.y*r,this.z=t.z*r,this.w=Math.cos(n),this}setFromRotationMatrix(t){const e=t.elements,n=e[0],r=e[4],i=e[8],s=e[1],a=e[5],o=e[9],h=e[2],u=e[6],l=e[10],c=n+a+l;let y;return c>0?(y=.5/Math.sqrt(c+1),this.w=.25/y,this.x=(u-o)*y,this.y=(i-h)*y,this.z=(s-r)*y):n>a&&n>l?(y=2*Math.sqrt(1+n-a-l),this.w=(u-o)/y,this.x=.25*y,this.y=(r+s)/y,this.z=(i+h)/y):a>l?(y=2*Math.sqrt(1+a-n-l),this.w=(i-h)/y,this.x=(r+s)/y,this.y=.25*y,this.z=(o+u)/y):(y=2*Math.sqrt(1+l-n-a),this.w=(s-r)/y,this.x=(i+h)/y,this.y=(o+u)/y,this.z=.25*y),this}setFromUnitVectors(t,e){let n=t.dot(e)+1;return n<1e-6?(n=0,Math.abs(t.x)>Math.abs(t.z)?(this.x=-t.y,this.y=t.x,this.z=0,this.w=n):(this.x=0,this.y=-t.z,this.z=t.y,this.w=n)):(this.x=t.y*e.z-t.z*e.y,this.y=t.z*e.x-t.x*e.z,this.z=t.x*e.y-t.y*e.x,this.w=n),this.normalize()}angleTo(t){return 2*Math.acos(Math.abs(Math.min(Math.max(this.dot(t),-1),1)))}rotateTowards(t,e){const n=this.angleTo(t);return 0!==n&&this.slerp(t,Math.min(1,e/n)),this}invert(){return this.conjugate()}conjugate(){return this.x*=-1,this.y*=-1,this.z*=-1,this}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}normalize(){const t=this.length();let e;return 0===t?(this.x=0,this.y=0,this.z=0,this.w=1):(e=1/t,this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this.w=this.w*e),this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}multiplyQuaternions(t,e){const n=t.x,r=t.y,i=t.z,s=t.w,a=e.x,o=e.y,h=e.z,u=e.w;return this.x=n*u+s*a+r*h-i*o,this.y=r*u+s*o+i*a-n*h,this.z=i*u+s*h+n*o-r*a,this.w=s*u-n*a-r*o-i*h,this}multiply(t){return this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}slerp(t,e){const n=this.x,r=this.y,i=this.z,s=this.w;let a,o,h,u,l,c,y;return 1===e?this.copy(t):e>0&&(a=s*t.w+n*t.x+r*t.y+i*t.z,a<0?(this.w=-t.w,this.x=-t.x,this.y=-t.y,this.z=-t.z,a=-a):this.copy(t),a>=1?(this.w=s,this.x=n,this.y=r,this.z=i):(o=1-a*a,l=1-e,o<=Number.EPSILON?(this.w=l*s+e*this.w,this.x=l*n+e*this.x,this.y=l*r+e*this.y,this.z=l*i+e*this.z,this.normalize()):(h=Math.sqrt(o),u=Math.atan2(h,a),c=Math.sin(l*u)/h,y=Math.sin(e*u)/h,this.w=s*c+this.w*y,this.x=n*c+this.x*y,this.y=r*c+this.y*y,this.z=i*c+this.z*y))),this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w}static slerp(t,e,n,r){return n.copy(t).slerp(e,r)}static slerpFlat(t,e,n,r,i,s,a){const o=i[s],h=i[s+1],u=i[s+2],l=i[s+3];let c,y,d,f,x,m,p,w,g=n[r],z=n[r+1],_=n[r+2],v=n[r+3];v===l&&g===o&&z===h&&_===u||(c=1-a,f=g*o+z*h+_*u+v*l,m=f>=0?1:-1,x=1-f*f,x>Number.EPSILON&&(d=Math.sqrt(x),p=Math.atan2(d,f*m),c=Math.sin(c*p)/d,a=Math.sin(a*p)/d),w=a*m,g=g*c+o*w,z=z*c+h*w,_=_*c+u*w,v=v*c+l*w,c===1-a&&(y=1/Math.sqrt(g*g+z*z+_*_+v*v),g*=y,z*=y,_*=y,v*=y)),t[e]=g,t[e+1]=z,t[e+2]=_,t[e+3]=v}};new a,new a;new a;new a,new a;new a,new a,new a;const p=[new a,new a,new a,new a];class w{constructor(t=0,e=0,n=0,r=0){this.x=t,this.y=e,this.z=n,this.w=r}set(t,e,n,r){return this.x=t,this.y=e,this.z=n,this.w=r,this}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t}setAxisAngleFromQuaternion(t){this.w=2*Math.acos(t.w);const e=Math.sqrt(1-t.w*t.w);return e<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=t.x/e,this.y=t.y/e,this.z=t.z/e),this}setAxisAngleFromRotationMatrix(t){const e=.01,n=t.elements,r=n[0],i=n[4],s=n[8],a=n[1],o=n[5],h=n[9],u=n[2],l=n[6],c=n[10];let y,d,f,x,m,p,w,g,z,_,v;return Math.abs(i-a)<e&&Math.abs(s-u)<e&&Math.abs(h-l)<e?Math.abs(i+a)<.1&&Math.abs(s+u)<.1&&Math.abs(h+l)<.1&&Math.abs(r+o+c-3)<.1?this.set(1,0,0,0):(y=Math.PI,m=(r+1)/2,p=(o+1)/2,w=(c+1)/2,g=(i+a)/4,z=(s+u)/4,_=(h+l)/4,m>p&&m>w?m<e?(d=0,f=.707106781,x=.707106781):(d=Math.sqrt(m),f=g/d,x=z/d):p>w?p<e?(d=.707106781,f=0,x=.707106781):(f=Math.sqrt(p),d=g/f,x=_/f):w<e?(d=.707106781,f=.707106781,x=0):(x=Math.sqrt(w),d=z/x,f=_/x),this.set(d,f,x,y)):(v=Math.sqrt((l-h)*(l-h)+(s-u)*(s-u)+(a-i)*(a-i)),Math.abs(v)<.001&&(v=1),this.x=(l-h)/v,this.y=(s-u)/v,this.z=(a-i)/v,this.w=Math.acos((r+o+c-1)/2)),this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this.w=t.w*e.w,this}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this}divideScalar(t){return this.x/=t,this.y/=t,this.z/=t,this.w/=t,this}applyMatrix4(t){const e=this.x,n=this.y,r=this.z,i=this.w,s=t.elements;return this.x=s[0]*e+s[4]*n+s[8]*r+s[12]*i,this.y=s[1]*e+s[5]*n+s[9]*r+s[13]*i,this.z=s[2]*e+s[6]*n+s[10]*r+s[14]*i,this.w=s[3]*e+s[7]*n+s[11]*r+s[15]*i,this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)+Math.abs(this.w-t.w)}distanceToSquared(t){const e=this.x-t.x,n=this.y-t.y,r=this.z-t.z,i=this.w-t.w;return e*e+n*n+r*r+i*i}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}normalize(){return this.divideScalar(this.length())}setLength(t){return this.normalize().multiplyScalar(t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this.w=Math.min(this.w,t.w),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this.w=Math.max(this.w,t.w),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this.w=Math.max(t.w,Math.min(e.w,this.w)),this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this.w+=(t.w-this.w)*e,this}lerpVectors(t,e,n){return this.subVectors(e,t).multiplyScalar(n).add(t)}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w}}var g=class{constructor(t=null,e=!1){this.value=t,this.done=e}reset(){this.value=null,this.done=!1}};
/**
 * sparse-octree v6.0.2 build Sat Jan 18 2020
 * https://github.com/vanruesc/sparse-octree
 * Copyright 2020 Raoul van Rüschen
 * @license Zlib
 */new Uint8Array([0,4]),new Uint8Array([1,5]),new Uint8Array([2,6]),new Uint8Array([3,7]),new Uint8Array([0,2]),new Uint8Array([1,3]),new Uint8Array([4,6]),new Uint8Array([5,7]),new Uint8Array([0,1]),new Uint8Array([2,3]),new Uint8Array([4,5]),new Uint8Array([6,7]);const z=[new Uint8Array([0,0,0]),new Uint8Array([0,0,1]),new Uint8Array([0,1,0]),new Uint8Array([0,1,1]),new Uint8Array([1,0,0]),new Uint8Array([1,0,1]),new Uint8Array([1,1,0]),new Uint8Array([1,1,1])];new a;const _=new a;class v{constructor(t,e,n,r=null){this.distance=t,this.distanceToRay=e,this.point=n,this.object=r}}const b=[new Uint8Array([4,2,1]),new Uint8Array([5,3,8]),new Uint8Array([6,8,3]),new Uint8Array([7,8,8]),new Uint8Array([8,6,5]),new Uint8Array([8,7,8]),new Uint8Array([8,8,7]),new Uint8Array([8,8,8])];function M(t,e,n,r){let i,s=0;return e<n?(i=e,s=0):(i=n,s=1),r<i&&(s=2),b[t][s]}const S=new a,O=new u,T=new u,P=new class{constructor(t=new a,e=new a(0,0,-1)){this.origin=t,this.direction=e}set(t,e){return this.origin.copy(t),this.direction.copy(e),this}copy(t){return this.origin.copy(t.origin),this.direction.copy(t.direction),this}clone(){return(new this.constructor).copy(this)}at(t,e=new a){return e.copy(this.direction).multiplyScalar(t).add(this.origin)}lookAt(t){return this.direction.copy(t).sub(this.origin).normalize(),this}recast(t){return this.origin.copy(this.at(t,p[0])),this}closestPointToPoint(t,e=new a){const n=e.subVectors(t,this.origin).dot(this.direction);return n>=0?e.copy(this.direction).multiplyScalar(n).add(this.origin):e.copy(this.origin)}distanceSquaredToPoint(t){const e=p[0].subVectors(t,this.origin).dot(this.direction);return e<0?this.origin.distanceToSquared(t):p[0].copy(this.direction).multiplyScalar(e).add(this.origin).distanceToSquared(t)}distanceToPoint(t){return Math.sqrt(this.distanceSquaredToPoint(t))}distanceToPlane(t){const e=t.normal.dot(this.direction),n=0!==e?-(this.origin.dot(t.normal)+t.constant)/e:0===t.distanceToPoint(this.origin)?0:-1;return n>=0?n:null}distanceSquaredToSegment(t,e,n,r){const i=p[0].copy(t).add(e).multiplyScalar(.5),s=p[1].copy(e).sub(t).normalize(),a=p[2].copy(this.origin).sub(i),o=.5*t.distanceTo(e),h=-this.direction.dot(s),u=a.dot(this.direction),l=-a.dot(s),c=a.lengthSq(),y=Math.abs(1-h*h);let d,f,x,m,w;return y>0?(d=h*l-u,f=h*u-l,x=o*y,d>=0?f>=-x?f<=x?(m=1/y,d*=m,f*=m,w=d*(d+h*f+2*u)+f*(h*d+f+2*l)+c):(f=o,d=Math.max(0,-(h*f+u)),w=-d*d+f*(f+2*l)+c):(f=-o,d=Math.max(0,-(h*f+u)),w=-d*d+f*(f+2*l)+c):f<=-x?(d=Math.max(0,-(-h*o+u)),f=d>0?-o:Math.min(Math.max(-o,-l),o),w=-d*d+f*(f+2*l)+c):f<=x?(d=0,f=Math.min(Math.max(-o,-l),o),w=f*(f+2*l)+c):(d=Math.max(0,-(h*o+u)),f=d>0?o:Math.min(Math.max(-o,-l),o),w=-d*d+f*(f+2*l)+c)):(f=h>0?-o:o,d=Math.max(0,-(h*f+u)),w=-d*d+f*(f+2*l)+c),void 0!==n&&n.copy(this.direction).multiplyScalar(d).add(this.origin),void 0!==r&&r.copy(s).multiplyScalar(f).add(i),w}intersectSphere(t,e=new a){const n=p[0].subVectors(t.center,this.origin),r=n.dot(this.direction),i=n.dot(n)-r*r,s=t.radius*t.radius;let o,h,u,l=null;return i<=s&&(o=Math.sqrt(s-i),h=r-o,u=r+o,(h>=0||u>=0)&&(l=h<0?this.at(u,e):this.at(h,e))),l}intersectsSphere(t){return this.distanceSqToPoint(t.center)<=t.radius*t.radius}intersectPlane(t,e=new a){const n=this.distanceToPlane(t);return null===n?null:this.at(n,e)}intersectsPlane(t){const e=t.distanceToPoint(this.origin);return 0===e||t.normal.dot(this.direction)*e<0}intersectBox(t,e=new a){const n=this.origin,r=this.direction,i=t.min,s=t.max,o=1/r.x,h=1/r.y,u=1/r.z;let l,c,y,d,f,x,m=null;return o>=0?(l=(i.x-n.x)*o,c=(s.x-n.x)*o):(l=(s.x-n.x)*o,c=(i.x-n.x)*o),h>=0?(y=(i.y-n.y)*h,d=(s.y-n.y)*h):(y=(s.y-n.y)*h,d=(i.y-n.y)*h),l<=d&&y<=c&&((y>l||l!=l)&&(l=y),(d<c||c!=c)&&(c=d),u>=0?(f=(i.z-n.z)*u,x=(s.z-n.z)*u):(f=(s.z-n.z)*u,x=(i.z-n.z)*u),l<=x&&f<=c&&((f>l||l!=l)&&(l=f),(x<c||c!=c)&&(c=x),c>=0&&(m=this.at(l>=0?l:c,e)))),m}intersectsBox(t){return null!==this.intersectBox(t,p[0])}intersectTriangle(t,e,n,r,i){const s=this.direction,a=p[0],o=p[1],h=p[2],u=p[3];let l,c,y,d,f,x=null;return o.subVectors(e,t),h.subVectors(n,t),u.crossVectors(o,h),l=s.dot(u),0===l||r&&l>0||(l>0?c=1:(c=-1,l=-l),a.subVectors(this.origin,t),y=c*s.dot(h.crossVectors(a,h)),y>=0&&(d=c*s.dot(o.cross(a)),d>=0&&y+d<=l&&(f=-c*a.dot(u),f>=0&&(x=this.at(f/l,i))))),x}applyMatrix4(t){return this.origin.applyMatrix4(t),this.direction.transformDirection(t),this}equals(t){return t.origin.equals(this.origin)&&t.direction.equals(this.direction)}};const V=new class{constructor(){this.value=0}};const k=new u;class I{constructor(t,e=null){this.octree=t,this.region=e,this.cull=null!==e,this.result=new g,this.trace=null,this.indices=null,this.reset()}reset(){const t=this.octree.root;return this.trace=[],this.indices=[],null!==t&&(k.min=t.min,k.max=t.max,this.cull&&!this.region.intersectsBox(k)||(this.trace.push(t),this.indices.push(0))),this.result.reset(),this}next(){const t=this.cull,e=this.region,n=this.indices,r=this.trace;let i,s,a,o=null,h=r.length-1;for(;null===o&&h>=0;)if(i=n[h]++,s=r[h].children,i<8)if(null!==s){if(a=s[i],t&&(k.min=a.min,k.max=a.max,!e.intersectsBox(k)))continue;r.push(a),n.push(0),++h}else o=r.pop(),n.pop();else r.pop(),n.pop(),--h;return this.result.value=o,this.result.done=null===o,this.result}return(t){return this.result.value=t,this.result.done=!0,this.result}[Symbol.iterator](){return this}}const D=new u;const B=new a;class q extends class{constructor(t=new a,e=new a){this.min=t,this.max=e,this.children=null}getCenter(t){return t.addVectors(this.min,this.max).multiplyScalar(.5)}getDimensions(t){return t.subVectors(this.max,this.min)}split(){const t=this.min,e=this.max,n=this.getCenter(_),r=this.children=[null,null,null,null,null,null,null,null];let i,s;for(i=0;i<8;++i)s=z[i],r[i]=new this.constructor(new a(0===s[0]?t.x:n.x,0===s[1]?t.y:n.y,0===s[2]?t.z:n.z),new a(0===s[0]?n.x:e.x,0===s[1]?n.y:e.y,0===s[2]?n.z:e.z))}}{constructor(t,e){super(t,e),this.points=null,this.data=null}distanceToSquared(t){return B.copy(t).clamp(this.min,this.max).sub(t).lengthSquared()}distanceToCenterSquared(t){const e=this.getCenter(B),n=t.x-e.x,r=t.y-e.x,i=t.z-e.z;return n*n+r*r+i*i}contains(t,e){const n=this.min,r=this.max;return t.x>=n.x-e&&t.y>=n.y-e&&t.z>=n.z-e&&t.x<=r.x+e&&t.y<=r.y+e&&t.z<=r.z+e}redistribute(t){const e=this.children,n=this.points,r=this.data;let i,s,a,o,h,u,l;if(null!==e&&null!==n){for(i=0,a=n.length;i<a;++i)for(u=n[i],l=r[i],s=0,o=e.length;s<o;++s)if(h=e[s],h.contains(u,t)){null===h.points&&(h.points=[],h.data=[]),h.points.push(u),h.data.push(l);break}this.points=null,this.data=null}}merge(){const t=this.children;if(null!==t){let e,n,r,i=[],s=[];for(e=0,n=t.length;e<n;++e)r=t[e],null!==r.points&&(i=i.concat(r.points),s=s.concat(r.data));this.children=null,this.points=i,this.data=s}}}function A(t){const e=t.children;let n,r,i=0;if(null!==e)for(n=0,r=e.length;n<r;++n)i+=A(e[n]);else null!==t.points&&(i=t.points.length);return i}function E(t,e,n,r,i){let s,a,o=r.children,h=!1,u=!1;if(r.contains(t,n.bias)){if(null===o){if(null===r.points)r.points=[],r.data=[];else for(s=0,a=r.points.length;!h&&s<a;++s)h=r.points[s].equals(t);h?(r.data[s-1]=e,u=!0):r.points.length<n.maxPoints||i===n.maxDepth?(r.points.push(t.clone()),r.data.push(e),++n.pointCount,u=!0):(r.split(),r.redistribute(n.bias),o=r.children)}if(null!==o)for(++i,s=0,a=o.length;!u&&s<a;++s)u=E(t,e,n,o[s],i)}return u}function L(t,e,n,r){const i=n.children;let s,a,o,h,u,l=null;if(n.contains(t,e.bias))if(null!==i)for(s=0,a=i.length;null===l&&s<a;++s)l=L(t,e,i[s],n);else if(null!==n.points)for(o=n.points,h=n.data,s=0,a=o.length;s<a;++s)if(o[s].equals(t)){u=a-1,l=h[s],s<u&&(o[s]=o[u],h[s]=h[u]),o.pop(),h.pop(),--e.pointCount,null!==r&&A(r)<=e.maxPoints&&r.merge();break}return l}class j extends class{constructor(t){this.root=t}get min(){return this.root.min}get max(){return this.root.max}get children(){return this.root.children}getCenter(t){return this.root.getCenter(t)}getDimensions(t){return this.root.getDimensions(t)}cull(t){const e=[];return function t(e,n,r){const i=e.children;let s,a;if(D.min=e.min,D.max=e.max,n.intersectsBox(D))if(null!==i)for(s=0,a=i.length;s<a;++s)t(i[s],n,r);else r.push(e)}(this.root,t,e),e}getDepth(){return function t(e){const n=e.children;let r,i,s,a=0;if(null!==n)for(r=0,i=n.length;r<i;++r)s=1+t(n[r]),s>a&&(a=s);return a}(this.root)}findNodesByLevel(t){const e=[];return function t(e,n,r,i){const s=e.children;let a,o;if(r===n)i.push(e);else if(null!==s)for(++r,a=0,o=s.length;a<o;++a)t(s[a],n,r,i)}(this.root,t,0,e),e}raycast(t,e=[]){return class{static intersectOctree(t,e,n=[]){const r=function(t,e,n){const r=O.min.set(0,0,0),i=O.max.subVectors(t.max,t.min),s=t.getDimensions(T.min),a=T.max.copy(s).multiplyScalar(.5),o=P.origin.copy(e.origin),h=P.direction.copy(e.direction);let u,l,c,y,d,f,x,m,p;return o.sub(t.getCenter(S)).add(a),n.value=0,h.x<0&&(o.x=s.x-o.x,h.x=-h.x,n.value|=4),h.y<0&&(o.y=s.y-o.y,h.y=-h.y,n.value|=2),h.z<0&&(o.z=s.z-o.z,h.z=-h.z,n.value|=1),u=1/h.x,l=1/h.y,c=1/h.z,y=(r.x-o.x)*u,d=(i.x-o.x)*u,f=(r.y-o.y)*l,x=(i.y-o.y)*l,m=(r.z-o.z)*c,p=(i.z-o.z)*c,Math.max(Math.max(y,f),m)<Math.min(Math.min(d,x),p)?[y,f,m,d,x,p]:null}(t,e,V);null!==r&&function t(e,n,r,i,s,a,o,h){if(s>=0&&a>=0&&o>=0){const u=e.children;if(null===u)h.push(e);else{const e=.5*(n+s),l=.5*(r+a),c=.5*(i+o),y=V.value;let d=function(t,e,n,r,i,s){let a=0;return t>e&&t>n?(i<t&&(a|=2),s<t&&(a|=1)):e>n?(r<e&&(a|=4),s<e&&(a|=1)):(r<n&&(a|=4),i<n&&(a|=2)),a}(n,r,i,e,l,c);do{switch(d){case 0:t(u[y],n,r,i,e,l,c,h),d=M(d,e,l,c);break;case 1:t(u[1^y],n,r,c,e,l,o,h),d=M(d,e,l,o);break;case 2:t(u[2^y],n,l,i,e,a,c,h),d=M(d,e,a,c);break;case 3:t(u[3^y],n,l,c,e,a,o,h),d=M(d,e,a,o);break;case 4:t(u[4^y],e,r,i,s,l,c,h),d=M(d,s,l,c);break;case 5:t(u[5^y],e,r,c,s,l,o,h),d=M(d,s,l,o);break;case 6:t(u[6^y],e,l,i,s,a,c,h),d=M(d,s,a,c);break;case 7:t(u[7^y],e,l,c,s,a,o,h),d=8}}while(d<8)}}}(t.root,...r,n)}}.intersectOctree(this,t.ray,e),e}leaves(t){return new I(this,t)}[Symbol.iterator](){return new I(this)}}{constructor(t,e,n=0,r=8,i=8){super(new q(t,e)),this.bias=Math.max(0,n),this.maxPoints=Math.max(1,Math.round(r)),this.maxDepth=Math.max(0,Math.round(i)),this.pointCount=0}countPoints(t){return A(t)}insert(t,e){return E(t,e,this,this.root,0)}remove(t){return L(t,this,this.root,null)}get(t){return function t(e,n,r){const i=r.children;let s,a,o,h=null;if(r.contains(e,n.bias))if(null!==i)for(s=0,a=i.length;null===h&&s<a;++s)h=t(e,n,i[s]);else if(null!==r.points)for(o=r.points,s=0,a=o.length;null===h&&s<a;++s)e.equals(o[s])&&(h=r.data[s]);return h}(t,this,this.root)}move(t,e){return function t(e,n,r,i,s,a){const o=i.children;let h,u,l,c=null;if(i.contains(e,r.bias))if(i.contains(n,r.bias)){if(null!==o)for(++a,h=0,u=o.length;null===c&&h<u;++h)c=t(e,n,r,o[h],i,a);else if(null!==i.points)for(l=i.points,h=0,u=l.length;h<u;++h)if(e.equals(l[h])){l[h].copy(n),c=i.data[h];break}}else c=L(e,r,i,s),E(n,c,r,s,a-1);return c}(t,e,this,this.root,null,0)}findNearestPoint(t,e=1/0,n=!1){const r=function t(e,n,r,i){let s,a,o=null,h=n;if(null!==i.children){const n=i.children.map(t=>({octant:t,distance:t.distanceToCenterSquared(e)})).sort((t,e)=>t.distance-e.distance);let u,l;for(s=0,a=n.length;s<a&&(u=n[s].octant,!u.contains(e,h)||(l=t(e,h,r,u),null===l||(h=l.distance,o=l,0!==h)));++s);}else if(null!==i.points){const t=i.points;let n,u=-1;for(s=0,a=t.length;s<a;++s)if(t[s].equals(e)){if(!r){h=0,u=s;break}}else n=e.distanceTo(t[s]),n<h&&(h=n,u=s);u>=0&&(o={point:t[u],data:i.data[u],distance:h})}return o}(t,e,n,this.root);return null!==r&&(r.point=r.point.clone()),r}findPoints(t,e,n=!1){const r=[];return function t(e,n,r,i,s){const a=i.children;let o,h;if(null!==a){let i;for(o=0,h=a.length;o<h;++o)i=a[o],i.contains(e,n)&&t(e,n,r,i,s)}else if(null!==i.points){const t=i.points,a=n*n;let u;for(o=0,h=t.length;o<h;++o)u=t[o],u.equals(e)?r||s.push({point:u.clone(),data:i.data[o]}):u.distanceToSquared(e)<=a&&s.push({point:u.clone(),data:i.data[o]})}}(t,e,n,this.root,r),r}raycast(t,e=[]){const n=super.raycast(t);return n.length>0&&function(t,e,n){const r=e.params.Points.threshold,i=r*r;let s,o,h,u,l,c,y,d,f,x,m;for(l=0,y=t.length;l<y;++l)if(f=t[l],x=f.points,null!==x)for(c=0,d=x.length;c<d;++c)m=x[c],u=e.ray.distanceSqToPoint(m),u<i&&(s=e.ray.closestPointToPoint(m,new a),o=e.ray.origin.distanceTo(s),o>=e.near&&o<=e.far&&(h=Math.sqrt(u),n.push(new v(o,h,s,f.data[c]))))}(n,t,e),e}}var N={LOD:{maxPoints:1,maxDepth:80},setLOD:function(t,e){void 0!==t&&(this.LOD.maxPoints=t),void 0!==e&&(this.LOD.maxDepth=e)},getLOD:function(){return this.LOD}};function C(t){return(C="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function R(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function F(t){return(F=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function U(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function G(t,e){return(G=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var H=function(t){function e(t){var n;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),n=function(t,e){return!e||"object"!==C(e)&&"function"!=typeof e?U(t):e}(this,F(e).call(this,t)),i()(U(n)),Object.assign(U(n),N),n}var n,r,a;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&G(t,e)}(e,t),n=e,(r=[{key:"load",value:function(t,e,n,r){var i=this,a=new s.FileLoader(this.manager);a.setPath(this.path),a.load(t,(function(t){i.parse(t).then((function(t){return e(t)})).catch((function(t){return console.error(t)}))}),n,r)}},{key:"parse",value:function(t){var e=this;return new Promise((function(n,r){for(var i=-(t[0][0].length-1)/2,a=(t[0][0].length-1)/2,o=-(t.length-1)/2,h=(t.length-1)/2,u=-(t[0].length-1)/2,l=(t[0].length-1)/2,c=new s.Vector3(i,u,o),y=new s.Vector3(a,l,h),d=new j(c,y,0,e.LOD.maxPoints,e.LOD.maxDepth),f={},x=0;x<t.length;x++)for(var m=0;m<t[x].length;m++)for(var p=0;p<t[x][m].length;p++)if(1===t[x][m][p]){var w=p-(t[x][m].length-1)/2,g=m-(t[x].length-1)/2,z=x-(t.length-1)/2;d.insert(new s.Vector3(w,g,z),f)}n(d)}))}}])&&R(n.prototype,r),a&&R(n,a),e}(s.Loader);function X(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}var Y=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),i()(this),Object.assign(this,N)}var e,n,r;return e=t,(n=[{key:"parse",value:function(t){var e=this;return new Promise((function(n){var r=new j(t.root.min,t.max,0,e.LOD.maxPoints,e.LOD.maxDepth),i=!0,s=!1,a=void 0;try{for(var o,h=t.leaves()[Symbol.iterator]();!(i=(o=h.next()).done);i=!0){var u,l=o.value;if(null!==l.points)for(u=0;u<l.points.length;u++){var c=l.points[u],y=l.data[u];r.insert(c,y)}}}catch(t){s=!0,a=t}finally{try{i||null==h.return||h.return()}finally{if(s)throw a}}n(r)}))}}])&&X(e.prototype,n),r&&X(e,r),t}(),Z=n(2);function K(t){return(K="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function Q(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function W(t){return(W=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function $(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function J(t,e){return(J=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var tt=function(t){function e(t){var n;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),n=function(t,e){return!e||"object"!==K(e)&&"function"!=typeof e?$(t):e}(this,W(e).call(this,t)),i()($(n)),Object.assign($(n),N),n}var n,r,a;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&J(t,e)}(e,t),n=e,(r=[{key:"load",value:function(t,e,n,r){var i=this,a=new s.FileLoader(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.load(t,(function(t){i.parse(t).then((function(t){return e(t)})).catch((function(t){return console.error(t)}))}),n,r)}},{key:"parse",value:function(t){var e=this;return new Promise((function(n,r){Z.VoxReader.read(t,(function(t,i){i&&r(i);var a=[],o=new s.Vector3,h=new s.Matrix4,u=[];if(null==t.world){var l=t.sizes[0],c=new s.Vector3(l.x,l.z,l.y);u.push({model:0,position:new s.Vector3,rotation:new w,size:c})}else Z.VoxNodeTools.walkNodeGraph(t,{beginGraph:function(){},endGraph:function(){},onTransform:function(t){if(Z.VoxTools.dictHasTranslation(t)){var e=Z.VoxTools.getTranslationFromDict(t);a.push(new s.Vector3(e.x,e.z,e.y)),o.add(new s.Vector3(e.x,e.z,e.y))}else a.push(new s.Vector3);if(Z.VoxTools.dictHasRotation(t)){var n=Z.VoxTools.getRotationFromDict(t),r=new s.Matrix4;r.set(n._00,n._01,n._02,0,n._10,n._11,n._12,0,n._20,n._21,n._22,0,0,0,0,1),a.push(r),h.multiply(r)}else a.push(new s.Matrix4)},beginGroup:function(){},endGroup:function(){var t=a.pop(),e=a.pop();o.sub(e),h.multiply(t.getInverse(t))},onShape:function(e,n){var r=n[0].modelId,i=(new s.Vector3).add(o),l=(new s.Matrix4).multiply(h),c=t.sizes[r],y=new s.Vector3(c.x,c.z,c.y);u.push({model:r,position:i,rotation:l,size:y});var d=a.pop(),f=a.pop();o.sub(f),h.multiply(d.getInverse(d))}});for(var y=1/0,d=1/0,f=1/0,x=-1/0,m=-1/0,p=-1/0,g=0;g<u.length;g++){var z=u[g],_=z.position,v=z.size;_.x<y&&(y=_.x-v.x/2),_.y<d&&(d=_.y-v.y/2),_.z<f&&(f=_.z-v.z/2),_.x>x&&(x=_.x+v.x/2),_.y>m&&(m=_.y+v.y/2),_.z>p&&(p=_.z+v.z/2)}for(var b=new s.Vector3(y,d,f),M=new s.Vector3(x,m,p),S=new j(b,M,0,e.LOD.maxPoints,e.LOD.maxDepth),O=0;O<u.length;O++)for(var T=u[O].model,P=u[O].position,V=u[O].size,k=(new s.Vector3).copy(V).divideScalar(2),I=0;I<t.models[T].length;I++){var D=t.models[T][I],B=t.palette[D.colorIndex],q={color:{r:B.r,g:B.g,b:B.b}},A=new s.Vector3(D.x,D.z,D.y);A.sub(k),A.add(P),S.insert(A,q)}n(S)}))}))}}])&&Q(n.prototype,r),a&&Q(n,a),e}(s.Loader);function et(t){return(et="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function nt(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function rt(t){return(rt=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function it(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function st(t,e){return(st=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var at=function(t){function e(t){var n;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),n=function(t,e){return!e||"object"!==et(e)&&"function"!=typeof e?it(t):e}(this,rt(e).call(this,t)),i()(it(n)),Object.assign(it(n),N),n}var n,r,a;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&st(t,e)}(e,t),n=e,(r=[{key:"load",value:function(t,e,n,r){var i=this,a=new s.FileLoader(this.manager);a.setPath(this.path),a.load(t,(function(t){i.parse(t).then((function(t){return e(t)})).catch((function(t){return console.error(t)}))}),n,r)}},{key:"parse",value:function(t){var e=this;return new Promise((function(n,r){var i=(new DOMParser).parseFromString(t,"application/xml"),a=i.documentElement.getElementsByTagName("dimensions")[0],o=a.getElementsByTagName("width")[0].childNodes[0].nodeValue,h=a.getElementsByTagName("height")[0].childNodes[0].nodeValue,u=a.getElementsByTagName("depth")[0].childNodes[0].nodeValue,l=i.documentElement.getElementsByTagName("voxels")[0].getElementsByTagName("voxel"),c=new s.Vector3(-o/2,-h/2,-u/2),y=new s.Vector3(o/2,h/2,u/2),d=new j(c,y,0,e.LOD.maxPoints,e.LOD.maxDepth),f={};Array.from(l).forEach((function(t){for(var e=0;e<t.children.length;e++){var n=t.children[e],r=void 0,i=void 0,a=void 0;r=n.getElementsByTagName("x")[0].childNodes[0].nodeValue,i=n.getElementsByTagName("y")[0].childNodes[0].nodeValue,a=n.getElementsByTagName("z")[0].childNodes[0].nodeValue,r-=o/2,i-=h/2,a-=u/2,d.insert(new s.Vector3(r,i,a),f)}})),n(d)}))}}])&&nt(n.prototype,r),a&&nt(n,a),e}(s.Loader);function ot(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}var ht=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.manager=e}var e,n,r;return e=t,(n=[{key:"getLoader",value:function(t){switch(t){case"vox":return new tt(this.manager);case"xml":return new at(this.manager);case"array":return new H(this.manager);case"octree":return new Y;default:throw new Error("Unsupported type ("+t+").")}}}])&&ot(e.prototype,n),r&&ot(e,r),t}();function ut(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}var lt=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),i()(this),Object.assign(this,N),this.manager=e,this.octree=null,this.material=null,this.voxelSize=null,this.setVoxelMaterial(),this.setVoxelSize()}var e,n,r;return e=t,(n=[{key:"setVoxelMaterial",value:function(t){var e=new s.MeshPhongMaterial({color:16777215});(t=void 0!==t?t:e).vertexColors=s.VertexColors,this.material=t}},{key:"setVoxelSize",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.voxelSize=t}},{key:"update",value:function(){if(null===this.octree)throw new Error("Octree is not built");return this.parseData(this.octree,"octree")}},{key:"loadFile",value:function(t,e,n,r){var i=this,s=t.split(".").pop().toLowerCase(),a=new ht(this.manager).getLoader(s);a.setLOD(this.LOD.maxPoints,this.LOD.maxDepth),a.load(t,(function(t){i.octree=t,e(i.generateMesh(t))}),n,r)}},{key:"parseData",value:function(t,e){var n=this,r=new ht(this.manager).getLoader(e);return r.setLOD(this.LOD.maxPoints,this.LOD.maxDepth),new Promise((function(e){r.parse(t).then((function(t){n.octree=t,e(t)}))}))}},{key:"generateMesh",value:function(t){var e=new s.Geometry,n=this.material,r=!0,i=!1,a=void 0;try{for(var o,h=t.leaves()[Symbol.iterator]();!(r=(o=h.next()).done);r=!0){var u=o.value;if(null!==u.points){var l=new s.Vector3,c={x:u.points[0].x,y:u.points[0].y,z:u.points[0].z},y={x:u.points[0].x,y:u.points[0].y,z:u.points[0].z};for(z=0;z<u.points.length;z++){var d=u.points[z];l.add(d),c.x=Math.min(c.x,d.x),c.y=Math.min(c.y,d.y),c.z=Math.min(c.z,d.z),y.x=Math.max(y.x,d.x),y.y=Math.max(y.y,d.y),y.z=Math.max(y.z,d.z)}var f=Math.round(100*(this.voxelSize+(y.x-c.x)))/100,x=Math.round(100*(this.voxelSize+(y.y-c.y)))/100,m=Math.round(100*(this.voxelSize+(y.z-c.z)))/100,p=new s.BoxGeometry(f,x,m);l.divideScalar(z);var w=u.data[0].color;if(null!=w)for(var g=(new s.Color).setRGB(w.r/255,w.g/255,w.b/255),z=0;z<p.faces.length;z++)p.faces[z].color.set(g);p.translate(l.x,l.y,l.z),e.merge(p),p.translate(-l.x,-l.y,-l.z)}}}catch(t){i=!0,a=t}finally{try{r||null==h.return||h.return()}finally{if(i)throw a}}var _=(new s.BufferGeometry).fromGeometry(e);return _.computeFaceNormals(),_.computeVertexNormals(),new s.Mesh(_,n)}}])&&ut(e.prototype,n),r&&ut(e,r),t}();e.default=lt}])}));